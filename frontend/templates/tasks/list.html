<html>
<head>
{% load static %}
<link rel="stylesheet" href="{% get_static_prefix %}style.css" />
<script type="text/javascript" src="{% get_static_prefix %}jquery.min.js"></script>
<script type="text/javascript">
$('document').ready(function() {
    $('.cross_sub_button').live('click', function() {
        var id = $(this).attr('subtask_id')
        $.getJSON('cross_out_subtask/', { 'id': id, 'action': 'do_cross_subtask' }, function(data) {
            if (data['success']) {
                $('#subtask_'+id).removeClass('cross_sub_button').addClass('revive_sub_button')
                $('#subtask_'+id).siblings('span').addClass('cross_gray')
            }
        })
    })
    $('.revive_sub_button').live('click', function() {
        var id = $(this).attr('subtask_id')
        $.getJSON('revive_subtask/', { 'id': id, 'action': 'do_revive_subtask' }, function(data) {
            if (data['success']) {
                $('#subtask_'+id).removeClass('revive_sub_button').addClass('cross_sub_button')
                $('#subtask_'+id).siblings('span').removeClass('cross_gray')
            }
        })
    })
    $('.delete_sub_button').live('click', function() {
        var id = $(this).attr('subtask-id')
        $.getJSON('delete_subtask/', { 'id': id, 'action': 'do_delete_subtask' }, function(data) {
            if (data['success']) {
                $('#subtask_'+id+'_container').remove()
            }
        })
    })
    $('.delete_button').live('click', function() {
        var id = $(this).attr('task-id')
        $.getJSON('delete_task/', { 'id': id, 'action': 'do_delete_task' }, function(data) {
            if (data['success']) {
                $('#task_'+id+'_container').parent().remove()
            }
        })
    })
    $('.tick_button').live('click', function() {
        var id = $(this).attr('task-id')
        $.getJSON('cross_out_task/', { 'id': id, 'action': 'do_cross_task' }, function(data) {
            if (data['success']) {
                $('#task_'+id).removeClass('tick_button').addClass('revive_button')
                $('#task_'+id).siblings('span.task_name').addClass('cross_gray')
                $('#task_'+id).siblings('div.task_form').hide()
            }
        })
    })
    $('.revive_button').live('click', function() {
        var id = $(this).attr('task-id')
        $.getJSON('revive_task/', { 'id': id, 'action': 'do_revive_task' }, function(data) {
            if (data['success']) {
                $('#task_'+id).removeClass('revive_button').addClass('tick_button')
                $('#task_'+id).siblings('span.task_name').removeClass('cross_gray')
                $('#task_'+id).siblings('div.task_form').show().attr('display', 'inline')
            }
        })
    })
    $('.add_button').live('click', function() {
        var id = $(this).attr('task-id')
        var name = $('#subtask_name_'+id).val()
        $.getJSON('add_subtask/', { 'id': id, 'action': 'do_add_subtask', 'name': name }, function(data) {
            if (data['success']) {
                var new_id = data['id']
                $('#subtask_name_'+id).val('').focus()
                $('#task_'+id+'_container').siblings('div.subtasks_container')
                    .append(
                        $('<div>').addClass('subtask_div').attr('id', 'subtask_'+new_id+'_container')
                            .append($('<button>')
                                .attr({'id': 'del_subtask_'+new_id, 'subtask_id': new_id, 'type': 'button'})
                                .addClass('delete_sub_button')
                            )
                            .append($('<button>')
                                .attr({'id': 'cross_subtask_'+new_id, 'subtask_id': new_id, 'type': 'button'})
                                .addClass('cross_sub_button'))
                            .append($('<span>').html(name)
                        )
                    )
            }
        })
    })
});
</script>
</head>
<body>
<form action="add_task/" method="post">
    {% csrf_token %}
    <input type="text" name="new_task_name" maxlength="255" placeholder="nazwa zadania" size="60" autofocus="autofocus" />
    <input type="submit" value="Dodaj zadanie" />
    <input type="text" name="priority" maxlength="3" placeholder="priorytet" size="2" value="0" />
</form>

<hr />

{% if lista %}
<ol>
    {% for task in lista %}
    <li>
    <div id="task_{{ task.id }}_container" class="task_div">
        <button
            type="button"
            id="del_task_{{ task.id }}"
            task-id="{{ task.id }}"
            class="delete_button"
            title="usuń (wraz z podpunktami)"></button>
    {% if task.is_open %}
        <button
            type="button"
            id="task_{{ task.id }}"
            task-id="{{ task.id }}"
            class="tick_button"
            title="skreśl"></button>
        <span class="priority">({{ task.priority }}) </span><span class="task_name">{{ task }}</span>
        <div class="task_form" style="display: inline;">
            <input type="text" id="subtask_name_{{ task.id }}" placeholder="dodaj podpunkt" maxlength="255" size="50" />
            <button
                type="button"
                id="add_task_{{ task.id }}"
                task-id="{{ task.id }}"
                class="add_button" ></button>
        </div>
    {% else %}
        <button
            type="button"
            id="task_{{ task.id }}"
            task-id="{{ task.id }}"
            class="revive_button"
            title="odkreśl"></button>
        <span class="priority">({{ task.priority }}) </span><span class="cross_gray">{{ task }}</span>
    {% endif %}
    </div>
    <div class="subtasks_container">
        {% for subtask in task.subtask_set.all %}
        <div id="subtask_{{ subtask.id }}_container" class="subtask_div">
            <button
                type="button"
                id="del_subtask_{{ subtask.id }}"
                subtask-id="{{ subtask.id }}"
                class="delete_sub_button"
                title="skreśl"></button>
            <button
                type="button"
                id="subtask_{{ subtask.id }}"
                subtask_id="{{ subtask.id }}"
                class="{% if subtask.is_open %}cross_sub_button{% else %}revive_sub_button{% endif %}"
                title="skreśl"></button>
            <span {% if not subtask.is_open %}class="cross_gray"{% endif %}>{{ subtask }}</span>
        </div>
        {% endfor %}
    </div>
    </li>
    {% endfor %}
</ol>
{% else %}
<p>Nie ma zadań</p>
{% endif %}
</body>
</html>
